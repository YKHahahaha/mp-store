"use strict";const warn$1=t=>{throw new Error(`\n[MpStore warn]: ${t}\n\n`)},assert=(t,e)=>{t&&warn$1(e)},mergeState=(t,e)=>Object.freeze({...t,...e}),isEmptyObject=t=>{for(const e in t)return!1;return!0},remove=(t,e)=>{const n=t.indexOf(e);n>-1&&t.splice(n,1)},callHook=(t,e,n)=>{if(t&&"function"==typeof t[e])return t[e].apply(t,n)},mapObject=(t,e)=>{const n={};for(const s in t)t.hasOwnProperty(s)&&(n[s]=e(t[s]));return n},isPlainObject=t=>{if("object"!=typeof t||null===t)return!1;const e=Object.getPrototypeOf(t);if(null===e)return!0;let n=e;for(;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n};function mixin(t){const e=Object.create(null);if("function"==typeof t){t((t,n)=>{assert("string"!=typeof t||"functin"!=typeof n,"Mixed callback parameters are illegal."),assert(t in e,`The "${t}" is exist,`),e.name=n})}return e}const ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n){this.type=t,this.path=e,this.value=n}function diffValues(t,e,n,s){"function"==typeof t||null===t?s.push(new Patch(REPLACE,n,e)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,s):s.push(new Patch(REPLACE,n,e)):"object"==typeof t?null===e||"object"!=typeof e||Array.isArray(e)?s.push(new Patch(REPLACE,n,e)):t instanceof Date||e instanceof Date?s.push(new Patch(REPLACE,n,e)):walkObject(t,e,n,s):s.push(new Patch(REPLACE,n,e))}function walkArray(t,e,n,s){if(t.length<=e.length){let a=t.length;for(;--a>=0;)if(t[a]!==e[a]){const o=`${n}[${a}]`;diffValues(t[a],e[a],o,s)}if(e.length>t.length)for(a=e.length;--a>=t.length;){const t=`${n}[${a}]`;s.push(new Patch(ADD,t,e[a]))}}else s.push(new Patch(REPLACE,n,e))}function walkObject(t,e,n,s){for(const a in t){const o=`${n}.${a}`;a in e?t[a]!==e[a]&&diffValues(t[a],e[a],o,s):s.push(new Patch(REMOVE,o,null))}for(const a in e)if(!(a in t)){const t=`${n}.${a}`;s.push(new Patch(ADD,t,e[a]))}}function diff(t,e,n){const s=[];return walkObject(t,e,n,s),s}function applyPatchs(t,e){const n={};for(let t=0,s=e.length;t<s;t++){const{type:s,value:a,path:o}=e[t];n[o]=a}t.setData(n)}function updateComponent(t,e){for(let n=0,s=t.length;n<s;n++){const{isPage:s,component:a,didUpdate:o,willUpdate:i,createState:c}=t[n];if(a.data.global){const t=c();if("function"==typeof i&&!1===i(t))continue;const n=diff(a.data.global,t,GLOBALWORD);if(n.length>0){if(!1===callHook(e,"willUpdate",[a,t,n,s]))continue;applyPatchs(a,n),"function"==typeof o&&o(t),callHook(e,"didUpdate",[a,t,s])}}}}const COMMONACTION="*",match=(t,e)=>e===COMMONACTION||e===t.action,handleLayer=(t,e,n,s,a)=>{try{t.call(n,s,a)}catch(t){const a=n.hooks;a&&"function"==typeof a.middlewareError?a.middlewareError(e,s,t):warn(`${t}\n\n   --- from [${e}] action.`)}};class Middleware{constructor(t){this.stack=[],this.store=t}use(t,e){this.stack.push({fn:e,action:t})}remove(t,e){const n=this.stack.findIndex(n=>n.fn===e&&n.action===t);n>-1&&this.stack.splice(n,1)}handle(t,e){if(this.stack.length>0){let n=0;const s=e=>{let a=this.stack[n];for(;a&&!match(a,t);)a=this.stack[++n];a&&handleLayer(a.fn,t,this.store,e,s),n++};s(e)}}}let GLOBALWORD="global";const assertReducer=(t,e,n)=>{const{setter:s,partialState:a}=n;assert(!("partialState"in n),`You must defined "partialState" of "${e}".`),assert(!a||"object"!=typeof a,`The partialState of "${e}" must be an object.`);for(const e in a)assert(t.hasOwnProperty(e),`The "${e}" already exists in global state,`+"Please don't repeat defined.");return"function"!=typeof s&&(n.setter=()=>{warn$1(`Can't set "${e}" value. `+"Have you defined a setter?")}),n};class Store{constructor(t){this.state={},this.hooks=t,this.reducers=[],this.depComponents=[],this.isDispatching=!1,this.middleware=new Middleware(this)}add(t,e){const{partialState:n}=assertReducer(this.state,t,e);e.action=t,this.reducers.push(e),this.state=mergeState(this.state,n)}dispatch(t,e){const{reducers:n,isDispatching:s}=this;assert(s,'It is not allowed to call "dispatch" during dispatch execution.'+`\n\n   --- from [${t}] action.`);const a=n.find(e=>e.action===t);assert(!a,`The "${t}" does not exist. `+"Maybe you have not defined.");const o=e=>{this.isDispatching=!0,this.middleware.remove(t,o);try{const t=a.setter(this.state,e);this.state=mergeState(this.state,t)}catch(e){this.isDispatching=!1,warn$1(`${e}\n\n   --- from [${t}] action setter.`)}updateComponent(this.depComponents,this.hooks),this.isDispatching=!1};this.middleware.use(t,o),this.middleware.handle(t,e)}use(t,e){return"string"!=typeof t&&(e=t,t=COMMONACTION),this.middleware.use(t,e),()=>this.middleware.remove(t,e)}setNamespace(t){"string"==typeof t&&(GLOBALWORD=t)}_rewirteCfgAndAddDep(t,e){const n=this,{data:s,storeConfig:a={}}=t,{didUpdate:o,willUpdate:i,defineReducer:c,defineGlobalState:r}=a;s?s[GLOBALWORD]={}:t.data={[GLOBALWORD]:{}},"function"==typeof c&&(c.call(n,n),delete t.storeConfig);const l=t=>{if(callHook(this.hooks,"addDep",[t,e]),"function"==typeof r){const s=r.call(n,n),a=()=>mapObject(s,t=>t(this.state)),c=a();isPlainObject(c)&&(this.depComponents.push({isPage:e,component:t,didUpdate:o,willUpdate:i,createState:a}),t.setData({[GLOBALWORD]:c}))}};if(e){const e=t.onLoad,s=t.onUnload;t.onLoad=function(t){l(this),this.store=n,"function"==typeof e&&e.call(this,t)},t.onUnload=function(t){"function"==typeof s&&s.call(this,t),this.store=null,remove(n.depComponents,this)}}else{t.lifetimes=t.lifetimes||{};const e=t.attached||t.lifetimes.attached,s=t.detached||t.lifetimes.detached;t.attached=t.lifetimes.attached=function(t){l(this),this.store=n,"function"==typeof e&&e.call(this,t)},t.detached=t.lifetimes.detached=function(t){"function"==typeof s&&s.call(this,t),this.store=null,remove(n.depComponents,this)}}}}const nativePage=Page,nativeComponent=Component,expandConfig=(t,e,n)=>{isEmptyObject(e)||(n?Object.assign(t,e):t.methods?Object.assign(t.methods,e):t.methods={...e})};function index(t,e){const n=new Store(e),s=mixin(t);return{createPage:function(t){expandConfig(t,s,!0),n._rewirteCfgAndAddDep(t,!0),callHook(e,"createBefore",[!0,t]);const a=nativePage.call(this,t);return callHook(e,"created",[!0]),a},createComponent:function(t){expandConfig(t,s,!1),n._rewirteCfgAndAddDep(t,!1),callHook(e,"createBefore",[!1,t]);const a=nativeComponent.call(this,t);return callHook(e,"created",[!0]),a},store:n}}module.exports=index;
