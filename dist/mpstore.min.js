"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],a=!0,r=!1,i=void 0;try{for(var o,c=t[Symbol.iterator]();!(a=(o=c.next()).done)&&(n.push(o.value),!e||n.length!==e);a=!0);}catch(t){r=!0,i=t}finally{try{a||null==c.return||c.return()}finally{if(r)throw i}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warn(t){throw new Error("\n\n[MpStore warn]: ".concat(t,"\n\n"))}function assert(t,e){t||warn(e)}function mergeState(t,e){return Object.freeze(Object.assign({},t,e))}function mixinMethods(t,e){for(var n in e)n in t||(t[n]=e[n])}function remove(t,e){var n=t.findIndex((function(t){return t.component===e}));n>-1&&t.splice(n,1)}function callHook(t,e,n){if(t&&"function"==typeof t[e])return t[e].apply(t,n)}function isEmptyObject(t){for(var e in t)return!1;return!0}function mapObject(t,e){var n={};for(var a in t)t.hasOwnProperty(a)&&(n[a]=e(t[a]));return n}function createWraper(t,e,n){return function(){for(var a,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return"function"==typeof e&&e.apply(this,i),"function"==typeof t&&(a=t.apply(this,i)),"function"==typeof n&&n.apply(this,i),a}}function isPlainObject(t){if("object"!==_typeof(t)||null===t)return!1;var e=Object.getPrototypeOf(t);if(null===e)return!0;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n}function mixin(t){var e=Object.create(null);if("function"==typeof t){t((function(t,n){assert("string"==typeof t,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(t in e),'The "'.concat(t,'" is exist,')),e[t]=n}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n,a){this.type=t,this.path=e,this.value=n,this.leftValue=a}function diffValues(t,e,n,a){"function"==typeof t||null===t?a.push(new Patch(REPLACE,n,e,t)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,a):a.push(new Patch(REPLACE,n,e,t)):"object"===_typeof(t)?null===e||"object"!==_typeof(e)||Array.isArray(e)?a.push(new Patch(REPLACE,n,e,t)):t instanceof Date||e instanceof Date?a.push(new Patch(REPLACE,n,e,t)):walkObject(t,e,n,a):a.push(new Patch(REPLACE,n,e,t))}function walkArray(t,e,n,a){if(t.length<=e.length){for(var r=t.length;--r>=0;)if(t[r]!==e[r]){var i="".concat(n,"[").concat(r,"]");diffValues(t[r],e[r],i,a)}if(e.length>t.length)for(r=e.length;--r>=t.length;){var o="".concat(n,"[").concat(r,"]");a.push(new Patch(ADD,o,e[r],t[r]))}}else a.push(new Patch(REPLACE,n,e,t))}function walkObject(t,e,n,a){for(var r in t){var i="".concat(n,".").concat(r);r in e?t[r]!==e[r]&&diffValues(t[r],e[r],i,a):a.push(new Patch(REMOVE,i,null,t[r]))}for(var o in e)if(!(o in t)){var c="".concat(n,".").concat(o);a.push(new Patch(ADD,c,e[o],null))}}function diff(t,e,n){var a=[];return walkObject(t,e,n,a),a}var REG=/(?<=[\[\].])[^\[\].]+/g;function separatePath(t,e){var n=e.match(REG);if(n){for(var a=-1,r=null,i=t,o=null;a++<n.length-2;)o=i,i=i[r=n[a]];return[i,r,o,n[n.length-1]]}}function restore(t,e){for(var n=e.length,a=new Map;--n>=0;){var r=e[n],i=r.type,o=r.path,c=r.leftValue,s=separatePath(t,o);if(s){var f=_slicedToArray(s,4),u=f[0],l=f[1],p=f[2],h=f[3];switch(i){case REMOVE:case REPLACE:u[h]=c;break;case ADD:Array.isArray(u)&&u===p[l]&&a.set(u,{key:l,prevTarget:p}),delete u[h]}}}return a.forEach((function(t,e){var n=t.key,a=t.prevTarget,r=new e.constructor;e.forEach((function(t){return r.push(t)})),a[n]=r})),t}var COMMONACTION=function(){};function match(t,e){return t.action===COMMONACTION||e===t.action}function handleLayer(t,e,n,a,r,i){try{e.call(n,a,r,t),i()}catch(e){var o=n.hooks;i(),o&&"function"==typeof o.middlewareError?o.middlewareError(t,a,e):warn("".concat(e,"\n\n   --- from middleware [").concat(t,"] action."))}}var Middleware=function(){function t(e){_classCallCheck(this,t),this.stack=[],this.store=e,this.isProcessing=!1}return _createClass(t,[{key:"use",value:function(t,e){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:e,action:t})}},{key:"remove",value:function(t,e){var n=this.stack.findIndex((function(n){return n.fn===e&&n.action===t}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(t,e,n){var a=this;this.isProcessing=!0;var r=function(){a.isProcessing=!1};if(this.stack.length>0){var i=0;!function e(o){var c=a.stack[i];for(i++;c&&!match(c,t);)c=a.stack[i++];c?handleLayer(t,c.fn,a.store,o,e,r):n(o,r)}(e)}else n(e,r)}}]),t}();function applyPatchs(t,e){for(var n={},a=0,r=e.length;a<r;a++){var i=e[a],o=i.value;n[i.path]=o}t.setData(n)}function updateComponents(t){var e=t.hooks,n=t.GLOBALWORD,a=t.depComponents,r=a.length;if(0!==r)for(var i=0;i<r;i++){var o=a[i],c=o.isPage,s=o.component,f=o.didUpdate,u=o.willUpdate,l=o.createState;if(s.data[n]){var p=l();if("function"==typeof u&&!1===u.call(t,s,p))continue;var h=diff(s.data[n],p,n);if(h.length>0){if(!1===callHook(e,"willUpdate",[s,p,h,c]))continue;applyPatchs(s,h),"function"==typeof f&&f.call(t,s,p,h),callHook(e,"didUpdate",[s,p,c])}}}}var storeId=0;function assertReducer(t,e,n){var a=n.setter,r=n.partialState;for(var i in assert("partialState"in n,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(r),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),r)assert(!t.hasOwnProperty(i),"The [".concat(i,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action."));return"function"!=typeof a&&(n.setter=function(){throw"Can't changed [".concat(e,"] action value. Have you defined a setter?")}),n}var Store=function(){function t(e){_classCallCheck(this,t),this.hooks=e,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.4",this.state=Object.freeze({}),this.middleware=new Middleware(this)}return _createClass(t,[{key:"add",value:function(t,e){assert(!this.reducers.find((function(e){return e.action===t})),"Can't repeat defined [".concat(t,"] action."));var n=assertReducer(this.state,t,e).partialState;e.action=t,this.reducers.push(e),this.state=mergeState(this.state,n)}},{key:"dispatch",value:function(t,e,n){var a=this,r=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(t,"] action."));var i=r.find((function(e){return e.action===t}));assert(i,'The "'.concat(t,'" does not exist. ')+"Maybe you have not defined."),this.middleware.process(t,e,(function(e,r){a.isDispatching=!0;try{var o=i.setter(a.state,e);assert(isPlainObject(o),"setter function should be return a plain object."),a.state=mergeState(a.state,o)}catch(e){a.isDispatching=!1,r(),warn("".concat(e,"\n\n   --- from [").concat(t,"] action."))}updateComponents(a),a.isDispatching=!1,r(),"function"==typeof n&&n()}))}},{key:"use",value:function(t,e){var n=this;return"function"==typeof t&&t!==COMMONACTION&&(e=t,t=COMMONACTION),this.middleware.use(t,e),function(){return n.middleware.remove(t,e)}}},{key:"setNamespace",value:function(t){assert(t&&"string"==typeof t,"The [namespace] must be a string"),this.GLOBALWORD=t}},{key:"_rewirteCfgAndAddDep",value:function(t,e){var n=this,a=null,r=this,i=t.data,o=t.storeConfig,c=void 0===o?{}:o,s=c.didUpdate,f=c.willUpdate,u=c.defineReducer,l=c.usedGlobalState;if(delete t.storeConfig,"function"==typeof u&&u.call(r,r),"function"==typeof l){var p=l.call(r,r);assert(isPlainObject(p),"[usedGlobalState] must return a plain object, "+"but now is return a [".concat(_typeof(p),"]")),a=function(){return mapObject(p,(function(t){return t(r.state)}))}}if(null!==a){var h=a();isPlainObject(h)&&(i?i[this.GLOBALWORD]=h:t.data=_defineProperty({},this.GLOBALWORD,h))}var d=function(t){if(!1!==callHook(n.hooks,"addDep",[t,e])&&null!==a&&t.data&&isPlainObject(t.data[n.GLOBALWORD])){n.depComponents.push({isPage:e,component:t,didUpdate:s,willUpdate:f,createState:a});var r=diff(t.data[n.GLOBALWORD],a(),n.GLOBALWORD);r.length>0&&applyPatchs(t,r)}};if(e)t.onLoad=createWraper(t.onLoad,(function(){d(this),this.store=r})),t.onUnload=createWraper(t.onUnload,null,(function(){this.store=null,remove(r.depComponents,this)}));else{t.lifetimes=t.lifetimes||{};var y=function(e){return t[e]||t.lifetimes[e]},v=function(e,n){return t[e]=t.lifetimes[e]=n};v("attached",createWraper(y("attached"),(function(){d(this),this.store=r}))),v("detached",createWraper(y("detached"),null,(function(){this.store=null,remove(r.depComponents,this)})))}}}]),t}(),version="0.0.4",nativePage=Page,nativeComponent=Component;function expandConfig(t,e,n){isEmptyObject(e)||(n?mixinMethods(t,e):(t.methods=t.methods||{},mixinMethods(t.methods,e)))}function index(t,e){var n=new Store(e),a=mixin(t);return Page=createWraper(nativePage,(function(t){callHook(e,"createBefore",[t,!0]),expandConfig(t,a,!0),n._rewirteCfgAndAddDep(t,!0)})),Component=createWraper(nativeComponent,(function(t){callHook(e,"createBefore",[t,!1]),expandConfig(t,a,!1),n._rewirteCfgAndAddDep(t,!1)})),n}exports.default=index,exports.restore=restore,exports.version=version;
