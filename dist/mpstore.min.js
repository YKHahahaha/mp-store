"use strict";const warn=t=>{throw new Error(`\n[MpStore warn]: ${t}\n\n`)},assert=(t,e)=>{t&&warn(e)},mergeState=(t,e)=>Object.freeze({...t,...e}),isEmptyObject=t=>{for(const e in t)return!1;return!0},remove=(t,e)=>{const n=t.indexOf(e);n>-1&&t.splice(n,1)},callHook=(t,e,n)=>{if(t&&"function"==typeof t[e])return t[e].apply(t,n)},mapObject=(t,e)=>{const n={};for(const s in t)t.hasOwnProperty(s)&&(n[s]=e(t[s]));return n},isPlainObject=t=>{if("object"!=typeof t||null===t)return!1;const e=Object.getPrototypeOf(t);if(null===e)return!0;let n=e;for(;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n};function mixin(t){const e=Object.create(null);if("function"==typeof t){t((t,n)=>{assert("string"!=typeof t||"functin"!=typeof n,"Mixed callback parameters are illegal."),assert(t in e,`The "${t}" is exist,`),e.name=n})}return e}const ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n){this.type=t,this.path=e,this.value=n}function diffValues(t,e,n,s){"function"==typeof t||null===t?s.push(new Patch(REPLACE,n,e)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,s):s.push(new Patch(REPLACE,n,e)):"object"==typeof t&&null!==e&&"object"==typeof e?t instanceof Date||e instanceof Date?s.push(new Patch(REPLACE,n,e)):walkObject(t,e,n,s):s.push(new Patch(REPLACE,n,e))}function walkArray(t,e,n,s){if(t.length<=e.length){let o=t.length;for(;--o>=0;)if(t[o]!==e[o]){const a=`${n}[${o}]`;diffValues(t[o],e[o],a,s)}if(e.length>t.length)for(o=e.length;--o>=t.length;){const t=`${n}[${o}]`;s.push(new Patch(ADD,t,e[o]))}}else s.push(new Patch(REPLACE,n,e))}function walkObject(t,e,n,s){for(const o in t){const a=`${n}.${o}`;o in e?t[o]!==e[o]&&diffValues(t[o],e[o],a,s):s.push(new Patch(REMOVE,a,null))}for(const o in e)if(!(o in t)){const t=`${n}.${o}`;s.push(new Patch(ADD,t,e[o]))}}function diff(t,e,n){const s=[];return walkObject(t,e,n,s),s}function applyPatchs(t,e){const n={};for(let t=0,s=e.length;t<s;t++){const{type:s,value:o,path:a}=e[t];n[a]=o}t.setData(n)}function updateComponent(t,e){for(let n=0,s=t.length;n<s;n++){const{isPage:s,component:o,didUpdate:a,willUpdate:i,createState:c}=t[n];if(o.data.global){const t=c();if("function"==typeof i&&!1===i(t))continue;const n=diff(o.data.global,t,GLOBALWORD);if(n.length>0){if(!1===callHook(e,"willUpdate",[o,t,n,s]))continue;applyPatchs(o,n),"function"==typeof a&&a(t),callHook(e,"didUpdate",[o,t,s])}}}}const COMMONACTION="*",match$1=(t,e)=>e===COMMONACTION||e===t.action;function Layer(t,e){this.fn=e,this.action=t}class Middleware{constructor(t){this.stack=[],this.store=t}use(t,e){this.stack.push(new Layer(t,e))}remove(t,e){const n=this.stack.findIndex(n=>n.fn===e&&n.action===t);n>-1&&this.stack.splice(n,1)}handle(t,e){if(this.stack.length>0){let n=0;const s=e=>{let o=this.stack[n];for(;o&&!match$1(o,t);)o=this.stack[++n];o&&o.fn.call(this.store,e,s),n++};s(e)}}}let GLOBALWORD="global";const assertReducer=(t,e,n)=>{const{setter:s,partialState:o}=n;assert(!("partialState"in n),`You must defined "partialState" of "${e}".`),assert(!o||"object"!=typeof o,`The partialState of "${e}" must be an object.`);for(const e in o)assert(t.hasOwnProperty(e),`The "${e}" already exists in global state,`+"Please don't repeat defined.");return"function"!=typeof s&&(n.setter=()=>{warn(`Can't set "${e}" value. `+"Have you defined a setter?")}),n};class Store{constructor(t){this.state={},this.hooks=t,this.reducers=[],this.depComponents=[],this.isDispatching=!1,this.middleware=new Middleware(this)}add(t,e){const{partialState:n}=assertReducer(this.state,t,e);e.action=t,this.reducers.push(e),this.state=mergeState(this.state,n)}dispatch(t,e){const{reducers:n,isDispatching:s}=this;assert(s,'It is not allowed to call "dispatch" during dispatch execution.'+`\n\n   --- from [${t}] action.`);const o=n.find(e=>e.action===t);assert(!o,`The "${t}" does not exist. `+"Maybe you have not defined.");const a=this.use(t,t=>{a();const e=o.setter(this.state,t);this.state=mergeState(this.state,e),updateComponent(this.depComponents,this.hooks)});this.middleware.handle(t,e)}use(t,e){"string"!=typeof t&&(e=t,t=COMMONACTION);const n=(n,s)=>{this.isDispatching=!0;try{e(n,s)}catch(e){this.isDispatching=!1,this.hooks&&"function"==typeof this.hooks[middlewareError]?this.hooks[middlewareError](t,n,e):warn(`${e}\n\n   --- from [${t}] action.`)}this.isDispatching=!1};return this.middleware.use(match,n),()=>this.middleware.remove(t,n)}setNamespace(t){"string"==typeof t&&(GLOBALWORD=t)}_rewirteCfgAndAddDep(t,e){const n=this,{data:s,storeConfig:o={}}=t,{didUpdate:a,willUpdate:i,defineReducer:c,defineGlobalState:r}=o;s?s[GLOBALWORD]={}:t.data={[GLOBALWORD]:{}},"function"==typeof c&&(c.call(n,n),delete t.storeConfig);const l=t=>{if(callHook(this.hooks,"addDep",[t,e]),"function"==typeof r){const s=r.call(n,n),o=()=>mapObject(s,t=>t(this.state)),c=o();isPlainObject(c)&&(this.depComponents.push({isPage:e,component:t,didUpdate:a,willUpdate:i,createState:o}),t.setData({[GLOBALWORD]:c}))}};if(e){const e=t.onLoad,s=t.onUnload;t.onLoad=function(t){l(this),this.store=n,"function"==typeof e&&e.call(this,t)},t.onUnload=function(t){"function"==typeof s&&s.call(this,t),this.store=null,remove(n.depComponents,this)}}else{t.lifetimes=t.lifetimes||{};const e=t.attached||t.lifetimes.attached,s=t.detached||t.lifetimes.detached;t.attached=t.lifetimes.attached=function(t){l(this),this.store=n,"function"==typeof e&&e.call(this,t)},t.detached=t.lifetimes.detached=function(t){"function"==typeof s&&s.call(this,t),this.store=null,remove(n.depComponents,this)}}}}const nativePage=Page,nativeComponent=Component,expandConfig=(t,e,n)=>{isEmptyObject(e)||(n?Object.assign(t,e):t.methods?Object.assign(t.methods,e):t.methods={...e})};function index(t,e){const n=new Store(e),s=mixin(t);return{createPage:function(t){expandConfig(t,s,!0),n._rewirteCfgAndAddDep(t,!0),callHook(e,"createBefore",[!0,t]),nativePage.call(this,t),callHook(e,"created",[!0])},createComponent:function(t){expandConfig(t,s,!1),n._rewirteCfgAndAddDep(t,!1),callHook(e,"createBefore",[!1,t]),nativeComponent.call(this,t),callHook(e,"created",[!0])},store:n}}module.exports=index;
