"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warn(t){throw new Error("\n\n[MpStore warn]: ".concat(t,"\n\n"))}function assert(t,e){t||warn(e)}function mergeState(t,e){return Object.freeze(Object.assign({},t,e))}function mixinMethods(t,e){for(var n in e)n in t||(t[n]=e[n])}function remove(t,e){var n=t.findIndex((function(t){return t.component===e}));n>-1&&t.splice(n,1)}function callHook(t,e,n){if(t&&"function"==typeof t[e])return t[e].apply(t,n)}function isEmptyObject(t){for(var e in t)return!1;return!0}function mapObject(t,e){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=e(t[r]));return n}function createWraper(t,e,n){return function(){for(var r,a=arguments.length,i=new Array(a),o=0;o<a;o++)i[o]=arguments[o];return"function"==typeof e&&e.apply(this,i),"function"==typeof t&&(r=t.apply(this,i)),"function"==typeof n&&n.apply(this,i),r}}function isPlainObject(t){if("object"!==_typeof(t)||null===t)return!1;var e=Object.getPrototypeOf(t);if(null===e)return!0;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n}function clone(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(null==t)return t;var n=_typeof(t);if("string"===n||"number"===n||"boolean"===n||"function"===n||t instanceof Date)return t;if(e.has(t))return e.get(t);var r="function"!=typeof t.constructor?Object.create(null):new t.constructor;for(var a in e.set(t,r),t)r[a]=clone(t[a],e);return r}function mixin(t){var e=Object.create(null);if("function"==typeof t){t((function(t,n){assert("string"==typeof t,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(t in e),'The "'.concat(t,'" is exist,')),e[t]=n}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n,r){this.type=t,this.path=e,this.value=n,this.leftValue=r}function diffValues(t,e,n,r){"function"==typeof t||null===t?r.push(new Patch(REPLACE,n,e,t)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,r):r.push(new Patch(REPLACE,n,e,t)):"object"===_typeof(t)?null===e||"object"!==_typeof(e)||Array.isArray(e)?r.push(new Patch(REPLACE,n,e,t)):t instanceof Date||e instanceof Date?r.push(new Patch(REPLACE,n,e,t)):walkObject(t,e,n,r):r.push(new Patch(REPLACE,n,e,t))}function walkArray(t,e,n,r){if(t.length<=e.length){for(var a=t.length;--a>=0;)if(t[a]!==e[a]){var i="".concat(n,"[").concat(a,"]");diffValues(t[a],e[a],i,r)}if(e.length>t.length)for(a=e.length;--a>=t.length;){var o="".concat(n,"[").concat(a,"]");r.push(new Patch(ADD,o,e[a],t[a]))}}else r.push(new Patch(REPLACE,n,e,t))}function walkObject(t,e,n,r){for(var a in t){var i="".concat(n,".").concat(a);a in e?t[a]!==e[a]&&diffValues(t[a],e[a],i,r):r.push(new Patch(REMOVE,i,null,t[a]))}for(var o in e)if(!(o in t)){var s="".concat(n,".").concat(o);r.push(new Patch(ADD,s,e[o],null))}}function diff$1(t,e,n){var r=[];return walkObject(t,e,n,r),r}var REG=/[^\[\].]+(?=[\[\].])/g;function separatePath(t,e){var n=e.match(REG);if(n&&n.shift()&&n.length>0){for(var r=-1,a=null,i=t,o=null;r++<n.length-2;)o=i,i=i[a=n[r]];return[i,a,o,n[n.length-1]]}}function restore(t,e){for(var n=e.length,r=new Map;--n>=0;){var a=e[n],i=a.type,o=a.path,s=a.leftValue,c=separatePath(t,o+".");if(c){var l=_slicedToArray(c,4),u=l[0],f=l[1],h=l[2],p=l[3];switch(i){case REMOVE:case REPLACE:u[p]=s;break;case ADD:Array.isArray(u)&&u===h[f]&&r.set(u,{key:f,prevTarget:h}),delete u[p]}}}return r.forEach((function(t,e){var n=t.key,r=t.prevTarget,a=new e.constructor;e.forEach((function(t){return a.push(t)})),r[n]=a})),t}function applyPatchs(t,e){for(var n={},r=0,a=e.length;r<a;r++){var i=e[r],o=i.value;n[i.path]=o}t.setData(n)}function updateComponents(t){var e=t.hooks,n=t.GLOBALWORD,r=t.depComponents,a=r.length;if(0!==a)for(var i=0;i<a;i++){var o=r[i],s=o.isPage,c=o.component,l=o.didUpdate,u=o.willUpdate,f=o.createState;if(c.data[n]){var h=f();if("function"==typeof u&&!1===u.call(t,c,h))continue;var p=diff$1(c.data[n],h,n);if(p.length>0){if(!1===callHook(e,"willUpdate",[c,h,p,s]))continue;applyPatchs(c,p),c.timeTravel&&c.timeTravel.push(p),"function"==typeof l&&l.call(t,c,h,p),callHook(e,"didUpdate",[c,h,s]),c.timeTravel.push(p)}}}}var TimeTravel=function(){function t(e,n,r){_classCallCheck(this,t),this.history=[],this.limit=r,this.component=e,this.GLOBALWORD=n,this.length=this.history.length,this.current=this.history.length}return _createClass(t,[{key:"push",value:function(t){this.limit>0&&(this.history.push(t),this.length=this.history.length)}},{key:"go",value:function(t){if(this.limit>0){var e=this.current+t;assert(e>=0&&e<this.history.length,"[Index] is not within the allowed range.");for(var n=this.component,r=clone(n.data);e-- >=0;){r=restore(r,clone(this.history[e]))}var a=diff(n.data,r,this.GLOBALWORD);a.length>0&&applyPatchs(n,a),this.current=e}}},{key:"forward",value:function(){this.go(1)}},{key:"back",value:function(){this.go(-1)}},{key:"start",value:function(){this.go(-this.current)}},{key:"end",value:function(){this.go(this.history.length-this.current)}}]),t}(),COMMONACTION=function(){};function match(t,e){return t.action===COMMONACTION||e===t.action}function handleLayer(t,e,n,r,a,i){try{e.call(n,r,a,t),i()}catch(e){var o=n.hooks;i(),o&&"function"==typeof o.middlewareError?o.middlewareError(t,r,e):warn("".concat(e,"\n\n   --- from middleware [").concat(t,"] action."))}}var Middleware=function(){function t(e){_classCallCheck(this,t),this.stack=[],this.store=e,this.isProcessing=!1}return _createClass(t,[{key:"use",value:function(t,e){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:e,action:t})}},{key:"remove",value:function(t,e){var n=this.stack.findIndex((function(n){return n.fn===e&&n.action===t}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(t,e,n){var r=this;this.isProcessing=!0;var a=function(){r.isProcessing=!1};if(this.stack.length>0){var i=0;!function e(o){var s=r.stack[i];for(i++;s&&!match(s,t);)s=r.stack[i++];s?handleLayer(t,s.fn,r.store,o,e,a):n(o,a)}(e)}else n(e,a)}}]),t}(),storeId=0;function assertReducer(t,e,n){var r=n.setter,a=n.partialState;for(var i in assert("partialState"in n,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(a),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),a)assert(!t.hasOwnProperty(i),"The [".concat(i,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action."));return"function"!=typeof r&&(n.setter=function(){throw"Can't changed [".concat(e,"] action value. Have you defined a setter?")}),n}var Store=function(){function t(e){_classCallCheck(this,t),this.hooks=e,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.7",this.state=Object.freeze({}),this.middleware=new Middleware(this)}return _createClass(t,[{key:"add",value:function(t,e){assert(!this.reducers.find((function(e){return e.action===t})),"Can't repeat defined [".concat(t,"] action."));var n=assertReducer(this.state,t,e).partialState;e.action=t,this.reducers.push(e),this.state=mergeState(this.state,n)}},{key:"dispatch",value:function(t,e,n){var r=this,a=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(t,"] action."));var i=a.find((function(e){return e.action===t}));assert(i,'The "'.concat(t,'" does not exist. ')+"Maybe you have not defined."),this.middleware.process(t,e,(function(e,a){r.isDispatching=!0;try{var o=i.setter(r.state,e);assert(isPlainObject(o),"setter function should be return a plain object."),r.state=mergeState(r.state,o)}catch(e){r.isDispatching=!1,a(),warn("".concat(e,"\n\n   --- from [").concat(t,"] action."))}updateComponents(r),r.isDispatching=!1,a(),"function"==typeof n&&n()}))}},{key:"use",value:function(t,e){var n=this;return"function"==typeof t&&t!==COMMONACTION&&(e=t,t=COMMONACTION),this.middleware.use(t,e),function(){return n.middleware.remove(t,e)}}},{key:"setNamespace",value:function(t){assert(t&&"string"==typeof t,"The [namespace] must be a string"),this.GLOBALWORD=t}},{key:"_rewirteCfgAndAddDep",value:function(t,e){var n=this,r=null,a=this,i=t.data,o=t.storeConfig,s=void 0===o?{}:o,c=s.didUpdate,l=s.willUpdate,u=s.defineReducer,f=s.timeTravel,h=void 0===f?0:f,p=s.usedGlobalState;if(delete t.storeConfig,"function"==typeof u&&u.call(a,a),"function"==typeof p){var d=p.call(a,a);assert(isPlainObject(d),"[usedGlobalState] must return a plain object, "+"but now is return a [".concat(_typeof(d),"]")),r=function(){return mapObject(d,(function(t){return t(a.state)}))}}if(null!==r){var y=r();isPlainObject(y)&&(i?i[this.GLOBALWORD]=y:t.data=_defineProperty({},this.GLOBALWORD,y))}var v=function(t){if(!1!==callHook(n.hooks,"addDep",[t,e])&&null!==r&&t.data&&isPlainObject(t.data[n.GLOBALWORD])){t.timeTravel=new TimeTravel(t,n.GLOBALWORD,h),n.depComponents.push({isPage:e,component:t,didUpdate:c,willUpdate:l,createState:r});var a=diff$1(t.data[n.GLOBALWORD],r(),n.GLOBALWORD);a.length>0&&applyPatchs(t,a)}};if(e)t.onLoad=createWraper(t.onLoad,(function(){v(this),this.store=a})),t.onUnload=createWraper(t.onUnload,null,(function(){this.store=null,this.timeTravel=null,remove(a.depComponents,this)}));else{t.lifetimes=t.lifetimes||{};var m=function(e){return t[e]||t.lifetimes[e]},g=function(e,n){return t[e]=t.lifetimes[e]=n};g("attached",createWraper(m("attached"),(function(){v(this),this.store=a}))),g("detached",createWraper(m("detached"),null,(function(){this.store=null,this.timeTravel=null,remove(a.depComponents,this)})))}}}]),t}(),version="0.0.7",nativePage=Page,nativeComponent=Component;function expandConfig(t,e,n){isEmptyObject(e)||(n?mixinMethods(t,e):(t.methods=t.methods||{},mixinMethods(t.methods,e)))}function index(t,e){var n=new Store(e),r=mixin(t);return Page=createWraper(nativePage,(function(t){callHook(e,"createBefore",[t,!0]),expandConfig(t,r,!0),n._rewirteCfgAndAddDep(t,!0)})),Component=createWraper(nativeComponent,(function(t){callHook(e,"createBefore",[t,!1]),expandConfig(t,r,!1),n._rewirteCfgAndAddDep(t,!1)})),n}exports.clone=clone,exports.default=index,exports.diff=diff$1,exports.restore=restore,exports.version=version;
