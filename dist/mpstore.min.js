"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function warn(t){throw new Error("\n\n[MpStore warn]: ".concat(t,"\n\n"))}function assert(t,e){t||warn(e)}function mergeState(t,e){return Object.freeze(Object.assign({},t,e))}function mixinMethods(t,e){for(var n in e)n in t||(t[n]=e[n])}function remove(t,e){var n=t.findIndex((function(t){return t.component===e}));n>-1&&t.splice(n,1)}function callHook(t,e,n){if(t&&"function"==typeof t[e])return t[e].apply(t,n)}function isEmptyObject(t){for(var e in t)return!1;return!0}function mapObject(t,e){var n={};for(var a in t)t.hasOwnProperty(a)&&(n[a]=e(t[a]));return n}function createWraper(t,e,n){return function(){for(var a,i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return"function"==typeof e&&e.apply(this,r),"function"==typeof t&&(a=t.apply(this,r)),"function"==typeof n&&n.apply(this,r),a}}function isPlainObject(t){if("object"!==_typeof(t)||null===t)return!1;var e=Object.getPrototypeOf(t);if(null===e)return!0;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n}function mixin(t){var e=Object.create(null);if("function"==typeof t){t((function(t,n){assert("string"==typeof t,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(t in e),'The "'.concat(t,'" is exist,')),e[t]=n}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n,a){this.type=t,this.path=e,this.value=n,this.leftValue=a}function diffValues(t,e,n,a){"function"==typeof t||null===t?a.push(new Patch(REPLACE,n,e,t)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,a):a.push(new Patch(REPLACE,n,e,t)):"object"===_typeof(t)?null===e||"object"!==_typeof(e)||Array.isArray(e)?a.push(new Patch(REPLACE,n,e,t)):t instanceof Date||e instanceof Date?a.push(new Patch(REPLACE,n,e,t)):walkObject(t,e,n,a):a.push(new Patch(REPLACE,n,e,t))}function walkArray(t,e,n,a){if(t.length<=e.length){for(var i=t.length;--i>=0;)if(t[i]!==e[i]){var r="".concat(n,"[").concat(i,"]");diffValues(t[i],e[i],r,a)}if(e.length>t.length)for(i=e.length;--i>=t.length;){var o="".concat(n,"[").concat(i,"]");a.push(new Patch(ADD,o,e[i],t[i]))}}else a.push(new Patch(REPLACE,n,e,t))}function walkObject(t,e,n,a){for(var i in t){var r="".concat(n,".").concat(i);i in e?t[i]!==e[i]&&diffValues(t[i],e[i],r,a):a.push(new Patch(REMOVE,r,null,t[i]))}for(var o in e)if(!(o in t)){var c="".concat(n,".").concat(o);a.push(new Patch(ADD,c,e[o],null))}}function diff(t,e,n){var a=[];return walkObject(t,e,n,a),a}var COMMONACTION=function(){};function match(t,e){return t.action===COMMONACTION||e===t.action}function handleLayer(t,e,n,a,i,r){try{e.call(n,a,i,t),r()}catch(e){var o=n.hooks;r(),o&&"function"==typeof o.middlewareError?o.middlewareError(t,a,err):warn("".concat(e,"\n\n   --- from middleware [").concat(t,"] action."))}}var Middleware=function(){function t(e){_classCallCheck(this,t),this.stack=[],this.store=e,this.isProcessing=!1}return _createClass(t,[{key:"use",value:function(t,e){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:e,action:t})}},{key:"remove",value:function(t,e){var n=this.stack.findIndex((function(n){return n.fn===e&&n.action===t}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(t,e,n){var a=this;this.isProcessing=!0;var i=function(){a.isProcessing=!1};if(this.stack.length>0){var r=0;!function e(o){var c=a.stack[r];for(r++;c&&!match(c,t);)c=a.stack[r++];c?handleLayer(t,c.fn,a.store,o,e,i):n(o,i)}(e)}else n(e,i)}}]),t}();function applyPatchs(t,e){for(var n={},a=0,i=e.length;a<i;a++){var r=e[a],o=r.value;n[r.path]=o}t.setData(n)}function updateComponents(t){var e=t.hooks,n=t.GLOBALWORD,a=t.depComponents,i=a.length;if(0!==i)for(var r=0;r<i;r++){var o=a[r],c=o.isPage,s=o.component,f=o.didUpdate,u=o.willUpdate,l=o.createState;if(s.data[n]){var d=l();if("function"==typeof u&&!1===u.call(t,s,d))continue;var p=diff(s.data[n],d,n);if(p.length>0){if(!1===callHook(e,"willUpdate",[s,d,p,c]))continue;applyPatchs(s,p),"function"==typeof f&&f.call(t,s,d,p),callHook(e,"didUpdate",[s,d,c])}}}}var storeId=0;function assertReducer(t,e,n){var a=n.setter,i=n.partialState;for(var r in assert("partialState"in n,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(i),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),i)assert(!t.hasOwnProperty(r),"The [".concat(r,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action."));return"function"!=typeof a&&(n.setter=function(){throw"Can't changed [".concat(e,"] action value. Have you defined a setter?")}),n}var Store=function(){function t(e){_classCallCheck(this,t),this.state={},this.hooks=e,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.3",this.middleware=new Middleware(this)}return _createClass(t,[{key:"add",value:function(t,e){assert(!this.reducers.find((function(e){return e.action===t})),"Can't repeat defined [".concat(t,"] action."));var n=assertReducer(this.state,t,e).partialState;e.action=t,this.reducers.push(e),this.state=mergeState(this.state,n)}},{key:"dispatch",value:function(t,e,n){var a=this,i=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(t,"] action."));var r=i.find((function(e){return e.action===t}));assert(r,'The "'.concat(t,'" does not exist. ')+"Maybe you have not defined."),this.middleware.process(t,e,(function(e,i){a.isDispatching=!0;try{var o=r.setter(a.state,e);assert(isPlainObject(o),"setter function should be return a plain object."),a.state=mergeState(a.state,o)}catch(e){a.isDispatching=!1,i(),warn("".concat(e,"\n\n   --- from [").concat(t,"] action."))}updateComponents(a),a.isDispatching=!1,i(),"function"==typeof n&&n()}))}},{key:"use",value:function(t,e){var n=this;return"function"==typeof t&&t!==COMMONACTION&&(e=t,t=COMMONACTION),this.middleware.use(t,e),function(){return n.middleware.remove(t,e)}}},{key:"setNamespace",value:function(t){assert(t&&"string"==typeof t,"The [namespace] must be a string"),this.GLOBALWORD=t}},{key:"_rewirteCfgAndAddDep",value:function(t,e){var n=this,a=null,i=this,r=t.data,o=t.storeConfig,c=void 0===o?{}:o,s=c.didUpdate,f=c.willUpdate,u=c.defineReducer,l=c.usedGlobalState;if(delete t.storeConfig,"function"==typeof u&&u.call(i,i),"function"==typeof l){var d=l.call(i,i);assert(isPlainObject(d),"[usedGlobalState] must return a plain object, "+"but now is return a [".concat(_typeof(d),"]")),a=function(){return mapObject(d,(function(t){return t(i.state)}))}}if(null!==a){var p=a();isPlainObject(p)&&(r?r[this.GLOBALWORD]=p:t.data=_defineProperty({},this.GLOBALWORD,p))}var h=function(t){if(!1!==callHook(n.hooks,"addDep",[t,e])&&null!==a&&isPlainObject(t.data[n.GLOBALWORD])){n.depComponents.push({isPage:e,component:t,didUpdate:s,willUpdate:f,createState:a});var i=diff(t.data[n.GLOBALWORD],a());i.length>0&&applyPatchs(t,i)}};if(e)t.onLoad=createWraper(t.onLoad,(function(){h(this),this.store=i})),t.onUnload=createWraper(t.onLoad,null,(function(){this.store=null,remove(i.depComponents,this)}));else{t.lifetimes=t.lifetimes||{};var y=function(e){return t[e]||t.lifetimes[e]},v=function(e,n){return t[e]=t.lifetimes[e]=n};v("attached",createWraper(y("attached"),(function(){h(this),this.store=i}))),v("detached",createWraper(y("detached"),null,(function(){this.store=null,remove(i.depComponents,this)})))}}}]),t}(),version="0.0.3",nativePage=Page,nativeComponent=Component;function expandConfig(t,e,n){isEmptyObject(e)||(n?mixinMethods(t,e):(t.methods=t.methods||{},mixinMethods(t.methods,e)))}function index(t,e){var n=new Store(e),a=mixin(t);return Page=createWraper(nativePage,(function(t){callHook(e,"createBefore",[t,!0]),expandConfig(t,a,!0),n._rewirteCfgAndAddDep(t,!0)})),Component=createWraper(nativeComponent,(function(t){callHook(e,"createBefore",[t,!1]),expandConfig(t,a,!1),n._rewirteCfgAndAddDep(t,!1)})),n}exports.default=index,exports.version=version;
